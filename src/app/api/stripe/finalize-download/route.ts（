import Stripe from "stripe";
import { createClient } from "@supabase/supabase-js";

export const runtime = "nodejs";

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: "2025-12-15.clover",
});

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!
);

export async function POST(req: Request) {
  try {
    const { sessionId, spaceId } = await req.json();
    if (!sessionId || !spaceId) return new Response("missing params", { status: 400 });

    // Stripeで支払い確認
    const session = await stripe.checkout.sessions.retrieve(sessionId);
    if (session.payment_status !== "paid") return new Response("not paid", { status: 402 });

    // space_id に紐づく画像URLを取得（最新1枚）
    const { data, error } = await supabase
      .from("photos")              // ←あなたの実テーブル名に合わせて
      .select("file_url")
      .eq("space_id", spaceId)
      .order("created_at", { ascending: false }) // created_at が無いならこの行は消してOK
      .limit(1);

    if (error) return new Response(`db error: ${error.message}`, { status: 500 });

    const url = data?.[0]?.file_url;
    if (!url) return new Response("no photo url", { status: 404 });

    return Response.json({ downloadUrl: url });
  } catch (e: any) {
    return new Response(e?.message || "server error", { status: 500 });
  }
}


function normalizeToStringArray(v: any): string[] {
  if (!v) return [];
  if (Array.isArray(v)) return v.filter((x) => typeof x === "string");
  // json文字列で入ってる場合
  if (typeof v === "string") {
    try {
      const parsed = JSON.parse(v);
      if (Array.isArray(parsed)) return parsed.filter((x) => typeof x === "string");
      // 文字列単体URLの可能性
      if (typeof parsed === "string") return [parsed];
      // URL文字列そのものの場合
      if (v.startsWith("http")) return [v];
    } catch {
      if (v.startsWith("http")) return [v];
    }
  }
  return [];
}
